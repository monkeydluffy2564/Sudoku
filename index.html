<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sudoku 4×4 - แข่งขันหลายคน (แก้ไขแล้ว)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root{
      --bg:#ffffff; --ink:#4b6b88; --ink-soft:#7ca7c8;
      --tile-bg:#ffffff; --tile-border:#cfefff; --num:#2b6cb0;
      --card-bg:#e9f6ff; --card-border:#9fd7ff; --card-ink:#2f7fb2;
      --accent:#2c77ff; --shadow:0 6px 16px rgba(43,119,255,.12);
      --select-ring: rgba(44,119,255,.45);
      --select-bg: #f5faff;
      --podium-1: #ffd700; --podium-2: #c0c0c0; --podium-3: #cd7f32;
      --conflict:#ef4444; --given:#0ea5e9; --ok:#22c55e;
      --hl:#fde68a; /* highlight row/col/subgrid */
    }
    :root[data-theme="pastel"]{ }
    :root[data-theme="chalk"]{
      --bg:#0c241a; --ink:#eaf7e0; --ink-soft:#bfe8c2; --tile-bg:#17382b; --tile-border:#2d6b52; --num:#eaf7e0;
      --card-bg:#133529; --card-border:#5cbf98; --card-ink:#d7ffe9; --accent:#87e7b2; --select-ring:#87e7b2; --select-bg:#0e392c;
      --hl:#254b3a; --conflict:#ff7f9f; --given:#3bcf7b; --ok:#a7f3d0;
    }
    :root[data-theme="blocks"]{
      --bg:#fbfbfb; --ink:#2b2b2b; --ink-soft:#6a6a6a; --tile-bg:#ffffff; --tile-border:#e6e6e6; --num:#2d7ef7;
      --card-bg:#f3f7ff; --card-border:#bcd7ff; --card-ink:#2d7ef7; --accent:#2d7ef7; --select-ring:#2d7ef7; --select-bg:#eef6ff;
      --hl:#eef2ff; --conflict:#ef4444; --given:#1d4ed8; --ok:#22c55e;
    }
    :root[data-theme="contrast"]{
      --bg:#ffffff; --ink:#111111; --ink-soft:#cccccc; --tile-bg:#ffffff; --tile-border:#000000; --num:#000000;
      --card-bg:#ffffff; --card-border:#000000; --card-ink:#000000; --accent:#006CFF; --select-ring:#006CFF; --select-bg:#E8F0FF;
      --hl:#f0f0f0; --conflict:#b91c1c; --given:#111; --ok:#16a34a;
    }
    :root[data-theme="neon"]{
      --bg: radial-gradient(1200px 800px at 30% 10%, #0d1b2a 0%, #000 70%);
      --ink:#d1e8ff; --ink-soft:#9cc9ff; --tile-bg:#0f2033; --tile-border:#1f3b5b; --num:#9ce6ff;
      --card-bg:#0e2238; --card-border:#00e5ff; --card-ink:#9ce6ff; --accent:#00e5ff; --select-ring:#00e5ff; --select-bg:#0a2942;
      --hl:#0f3653; --conflict:#ff2d95; --given:#ffc300; --ok:#00e5ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%; font-size:16px;}
    body{margin:0; background:var(--bg); color:var(--ink); font-family:"Kanit",system-ui,sans-serif; overflow-x:hidden;}
    .center-container{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;padding:1rem;}
    .toast{visibility:hidden;min-width:250px;background:#333;color:#fff;text-align:center;border-radius:8px;padding:16px;position:fixed;z-index:100;left:50%;transform:translateX(-50%);bottom:30px;opacity:0;transition:opacity .3s,visibility .3s}
    .toast.show{visibility:visible;opacity:1}

    .app{display:grid;grid-template-columns:1fr;gap:1.5rem;width:100%;max-width:1200px;height:auto;min-height:100%;padding:1rem;margin:0 auto;}
    .main-game{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;}

    .game-header{display:flex;justify-content:space-between;align-items:flex-start;width:100%;max-width:550px;margin-bottom:1rem;}
    .header-left,.header-right{flex:1;display:flex;flex-direction:column;gap:.5rem}
    .header-left{align-items:flex-start}.header-right{align-items:flex-end}
    .header-center{flex:1.5;text-align:center}
    .icon-btn-group{display:flex;gap:.5rem}
    .icon-btn{background:var(--tile-bg);border:2px solid var(--tile-border);color:var(--ink-soft);width:44px;height:44px;border-radius:.5rem;cursor:pointer;font-size:1.25rem;transition:all .2s}
    .icon-btn:hover{border-color:var(--accent);color:var(--accent)}
    #player-score-display{font-weight:600;font-size:1rem;color:var(--ink)}
    #puzzle-progress{font-weight:600;font-size:1rem;color:var(--accent)}
    .target-box{background:var(--accent);color:#fff;padding:.5rem 1rem;border-radius:.75rem;display:inline-block;margin-bottom:.5rem}
    .target-box .target-label{font-size:.875rem;opacity:.9}
    .target-box .target-number{font-size:1.25rem;font-weight:700;line-height:1}
    #game-timer{font-size:1.25rem;font-weight:600;color:var(--ink)}

    #game-board {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      flex-grow: 0; /* Prevent flexbox from stretching this container */
    }

    .sudoku {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      margin: 1rem auto;
      width: min(90vmin, 400px);
      aspect-ratio: 1 / 1; 
      border: 3px solid var(--ink, #111);
      border-radius: .75rem;
      overflow: hidden;
    }

    .cell {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--tile-bg);
      border-right: 1px solid var(--ink-soft, #ccc);
      border-bottom: 1px solid var(--ink-soft, #ccc);
      border-radius: 0;
      font-weight: 700;
      color: var(--num);
      font-size: clamp(1.5rem, 12vmin, 2.5rem);
      cursor: pointer;
      user-select: none;
      transition: box-shadow .15s, background .15s;
      aspect-ratio: 1 / 1;
    }

    .cell:nth-child(4n) { border-right: none; }
    .cell:nth-child(n+13) { border-bottom: none; }

    .cell.given {
      color: var(--given);
      cursor: default;
    }
    .cell.selected {
      box-shadow: 0 0 0 4px var(--select-ring);
      background: var(--select-bg);
      position: relative;
      z-index: 10;
    }
    .cell.hl {
      background: var(--hl);
    }
    .cell.conflict { background-color: #fee2e2; }
    .cell.ok { background-color: #dcfce7; }
    .cell.hl.conflict { background-color: #fecaca; }
    .cell.hl.ok { background-color: #bbf7d0; }

    .cell .tiny {
      font-size: 1rem;
      opacity: .6;
    }

    .bR {
      border-right: 3px solid var(--ink, #111);
    }
    .bB {
      border-bottom: 3px solid var(--ink, #111);
    }

    .picker{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center}
    .pick{width:56px;height:56px;border-radius:.75rem;background:var(--tile-bg);border:2px solid var(--tile-border);font-weight:900;font-size:1.5rem;color:var(--ink);cursor:pointer;transition:.15s}
    .pick:hover{border-color:var(--accent)}
    .pick.erase{font-size:1.1rem}

    .sidebar{background:var(--card-bg);border:2px solid var(--card-border);border-radius:1rem;padding:1rem;display:flex;flex-direction:column;order:-1}
    .leaderboard h3{color:var(--card-ink);font-weight:700;font-size:1.25rem;border-bottom:2px solid var(--card-border);padding-bottom:.5rem;margin-bottom:.75rem}
    .player-row{display:grid;grid-template-columns:1fr auto;align-items:center;padding:.5rem;border-radius:.5rem;margin-bottom:.25rem}
    .player-row.is-me{background-color:rgba(127,127,127,.2);border:1px solid var(--accent)}
    .player-name{font-weight:600;color:var(--card-ink)}
    .player-progress{font-weight:700;font-size:1rem;color:var(--accent);text-align:right}

    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:50;padding:1rem}
    .modal-content{background:#fff;color:#1f2937;padding:1.5rem;border-radius:1rem;width:100%;max-width:460px;box-shadow:0 18px 42px rgba(0,0,0,.35);text-align:center}
    #admin-settings-modal .modal-content{max-width:520px}
    .modal-content h2{font-size:1.5rem;font-weight:700;margin-bottom:.5rem}
    .modal-content p{color:#4b5563;margin-bottom:1rem}
    .modal-content button:disabled{background:#9ca3af;cursor:not-allowed}
    .modal-content input,.modal-content select{width:100%;padding:.75rem;border:1px solid #d1d5db;border-radius:.5rem;margin-bottom:1rem;text-align:center;font-size:1rem}
    .modal-content button{width:100%;padding:.75rem 1rem;border-radius:.5rem;border:0;font-weight:700;cursor:pointer;background:#4f46e5;color:white;transition:background-color .2s}
    .modal-content button:hover:not(:disabled){background:#4338ca}
    .modal-content .secondary-action{background:#e5e7eb;color:#374151;margin-top:.5rem}
    .modal-content .secondary-action:hover:not(:disabled){background:#d1d5db}

    .host-controls{margin-top:auto;padding-top:1rem;border-top:2px solid var(--card-border)}
    .host-controls button{width:100%;padding:.75rem;border-radius:.5rem;border:0;font-weight:700;cursor:pointer;background:var(--accent);color:white}

    .admin-lobby-container{text-align:center;padding:1.25rem}
    #game-code-display{font-size:clamp(3rem,20vw,5rem);font-weight:bold;color:var(--accent);letter-spacing:clamp(.25rem,2vw,.625rem);background:var(--card-bg);padding:1.25rem 2.5rem;border-radius:1.25rem;border:4px solid var(--card-border);margin:1.25rem 0;display:inline-block}
    .player-lobby-box{background:rgba(127,127,127,.1);border-radius:1rem;padding:1rem 1.5rem;width:100%;max-width:450px;margin:1rem auto}
    .player-lobby-box h3{font-size:1.125rem;font-weight:600;margin-bottom:1rem}
    #lobby-player-name-list{display:flex;flex-wrap:wrap;justify-content:center;gap:.75rem;min-height:40px}
    .lobby-player-tag{background:var(--card-bg);color:var(--card-ink);padding:.5rem 1.25rem;border-radius:9999px;font-weight:500;border:1px solid var(--card-border)}

    #game-over-view{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;padding:1rem}
    .results-container{width:100%;max-width:600px;text-align:center}
    .results-container h2{font-size:1.75rem;font-weight:700;margin-bottom:2rem}
    .podium{display:flex;align-items:flex-end;justify-content:center;gap:.5rem;height:250px;margin-bottom:2rem}
    .podium-stand{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;color:var(--ink);padding-bottom:1rem;border-radius:.5rem .5rem 0 0;box-shadow:var(--shadow)}
    .podium-stand .player-name{font-size:1.25rem;font-weight:600;margin-bottom:.25rem}
    .podium-stand .player-score{font-size:1rem;font-weight:500}
    .podium-stand .rank{font-size:2.5rem;font-weight:700;margin-top:.5rem}
    .podium-1{order:2;height:100%;background:var(--podium-1)}
    .podium-2{order:1;height:80%;background:var(--podium-2)}
    .podium-3{order:3;height:65%;background:var(--podium-3)}
    .podium-1 .fa-crown{color:#f9a825;font-size:2rem;margin-bottom:.5rem}
    .other-rankings{margin-top:1rem;background:var(--card-bg);border:2px solid var(--card-border);border-radius:1rem;padding:1rem}
    .other-rankings h3{font-size:1.25rem;font-weight:600;margin-bottom:.75rem}
    #other-rankings-list{list-style:none;padding:0}
    #other-rankings-list li{display:flex;justify-content:space-between;padding:.5rem;border-radius:.375rem}
    #other-rankings-list li:nth-child(odd){background-color:rgba(127,127,127,.05)}

    #admin-icon-btn{position:absolute;top:1rem;right:1rem;z-index:20;padding:.75rem;border-radius:9999px;color:var(--ink-soft);background:transparent;transition:.2s;border:none;cursor:pointer}
    #admin-icon-btn:hover{background:rgba(127,127,127,.1);color:var(--ink)}
    .loader{border:5px solid #f3f3f3;border-top:5px solid var(--accent);border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    
    body.player-view .sidebar{display:none}
    body.player-view .app{
        grid-template-columns: 1fr;
        place-items: center;
    }
    body.player-view .main-game{justify-content:center}

    .setting-group label{display:flex;align-items:center;justify-content:center;text-align:center;padding:.75rem;border:2px solid var(--tile-border);border-radius:.5rem;cursor:pointer;transition:.2s;min-height:50px}
    .setting-group input[type="radio"]:checked+label{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:600}
    .setting-group input[type="radio"]{display:none}

    @media (min-width:900px){
      .app{grid-template-columns:300px 1fr;height:auto;min-height:100%;padding:1.25rem}
      body.player-view .app {
        grid-template-columns: 1fr;
      }
      .sidebar{order:0}
      .main-game{justify-content:center}
      .app.sidebar-hidden {
        grid-template-columns: 1fr;
      }
      .app.sidebar-hidden .sidebar {
        display: none;
      }
    }
    .hidden{display:none !important}
  </style>
</head>
<body>

  <button id="admin-icon-btn" title="ผู้ดูแลระบบ">
    <i class="fas fa-user-shield fa-lg"></i>
  </button>

  <!-- Join -->
  <div id="player-join-view" class="center-container">
    <h1 class="text-5xl font-bold mb-4" style="color: var(--ink);">Sudoku Battle</h1>
    <div class="w-full max-w-md flex flex-col items-center gap-4">
        <!-- Join Competition Card -->
        <div class="modal-content w-full">
            <h2><i class="fas fa-users mr-2"></i>เข้าร่วมแข่งขัน</h2>
            <p>ใส่รหัสเกมและชื่อเล่นของคุณ</p>
            <input type="text" id="game-code-input" placeholder="รหัสเกม (2 หลัก)" maxlength="2" autocomplete="off" inputmode="numeric" pattern="[0-9]*">
            <input type="text" id="player-name-input" placeholder="ชื่อเล่น" maxlength="15" autocomplete="nickname">
            <button id="join-game-btn">เข้าร่วม</button>
        </div>

        <div class="text-center text-gray-500 my-1 font-semibold" style="color: var(--ink-soft);">หรือ</div>

        <!-- Practice Mode Card -->
        <div class="modal-content w-full">
             <h2><i class="fas fa-user mr-2"></i>โหมดฝึกซ้อม</h2>
             <p>เล่นคนเดียวเพื่อฝึกฝนทักษะ</p>
             <button id="start-practice-btn" style="background-color: #16a34a;">เริ่มโหมดฝึกซ้อม</button>
        </div>
    </div>
  </div>


  <!-- Waiting -->
  <div id="player-wait-view" class="hidden center-container">
    <div class="modal-content">
      <h2 class="text-2xl font-bold">เข้าร่วมสำเร็จ!</h2>
      <p class="text-lg">กรุณารอผู้ควบคุมเริ่มเกมสักครู่...</p>
      <div class="loader mt-4 mx-auto"></div>
    </div>
  </div>

  <!-- Admin Login -->
  <div id="admin-login-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2>เข้าสู่ระบบผู้ดูแล</h2>
      <p>กรุณาใส่รหัสผ่าน</p>
      <input type="password" id="admin-password-input" placeholder="รหัสผ่าน">
      <button id="admin-login-btn">เข้าสู่ระบบ</button>
      <button id="admin-back-btn" class="secondary-action">กลับ</button>
    </div>
  </div>

  <!-- Lobby -->
  <div id="admin-lobby-view" class="hidden center-container">
    <div class="admin-lobby-container">
      <h2 class="text-2xl font-semibold">เริ่มเกม: Sudoku 4×4</h2>
      <p class="text-lg mt-2">ให้นักเรียนเข้าร่วมด้วยรหัสนี้:</p>
      <div id="game-code-display">--</div>
      <div class="player-lobby-box">
        <h3>ผู้เล่นที่เข้าร่วม (<span id="lobby-player-count">0</span>)</h3>
        <div id="lobby-player-name-list"></div>
      </div>
      <button id="open-settings-btn" class="mt-4 px-8 py-3 text-xl rounded-lg bg-blue-600 text-white hover:bg-blue-700">
        ตั้งค่าและเริ่มเกม
      </button>
    </div>
  </div>

  <!-- Admin Settings -->
  <div id="admin-settings-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2>ตั้งค่าเกม</h2>
      <div class="space-y-4 my-4 text-left">
        <!-- Difficulty -->
        <div>
          <h3 class="font-semibold mb-2 text-sm">ความยาก</h3>
          <select id="difficulty-select">
            <option value="easy">ง่าย</option>
            <option value="medium" selected>ปานกลาง</option>
            <option value="hard">ยาก</option>
            <option value="mixed">โหมดผสม</option>
          </select>
        </div>
        <!-- Competition Only Settings -->
        <div id="competition-settings">
          <div>
            <h3 class="font-semibold mb-2 text-sm">รูปแบบการแสดงผลลัพธ์</h3>
            <div class="setting-group grid grid-cols-2 gap-2">
              <input type="radio" id="result-immediate" name="resultDisplayMode" value="immediate" checked>
              <label for="result-immediate" class="text-sm">แสดงผลทันที</label>
              <input type="radio" id="result-wait" name="resultDisplayMode" value="wait">
              <label for="result-wait" class="text-sm">รอจนหมดเวลา</label>
            </div>
          </div>
        </div>
        <!-- Time Limit -->
        <div>
          <h3 class="font-semibold mb-2 text-sm">เวลาจำกัด (วินาที)</h3>
          <input id="time-limit-input" type="number" min="10" max="1800" value="60" />
        </div>
      </div>
      <button id="start-game-btn"><i class="fas fa-play mr-2"></i>เริ่มแข่งขัน</button>
      <button id="cancel-settings-btn" class="secondary-action">ยกเลิก</button>
    </div>
  </div>

  <!-- Game -->
  <div id="game-view" class="app hidden">
    <div class="sidebar">
      <div class="theme-picker">
        <label for="themeSelect">ธีม</label>
        <select id="themeSelect" class="theme-select" aria-label="เลือกธีม">
          <option value="contrast">ความคมชัดสูง</option>
          <option value="pastel">พาสเทล</option>
          <option value="chalk">กระดานดำ</option>
          <option value="blocks">บล็อกสี</option>
          <option value="neon">นีออน</option>
        </select>
      </div>
      <div class="leaderboard flex-grow">
        <h3>ผู้เล่นในห้อง</h3>
        <div id="player-list"></div>
      </div>
      <div id="host-controls" class="host-controls hidden">
        <button id="end-game-btn">บังคับจบเกม</button>
      </div>
    </div>
    <div class="main-game">
      <div class="game-header">
        <div class="header-left">
          <div class="icon-btn-group">
            <button id="home-btn" class="icon-btn" title="ออกจากเกม"><i class="fas fa-home"></i></button>
            <button id="reset-btn" class="icon-btn" title="เริ่มใหม่"><i class="fas fa-redo"></i></button>
            <button id="toggle-sidebar-btn" class="icon-btn hidden" title="ซ่อน/แสดงผู้เล่น"><i class="fas fa-users"></i></button>
          </div>
          <div id="player-score-display" class="hidden">คะแนน: 0</div>
        </div>
        <div class="header-center">
          <div class="target-box">
            <div class="target-label">เป้าหมาย</div>
            <div id="target-number-display" class="target-number">Sudoku 4×4</div>
          </div>
          <div id="game-timer">เวลา: 01:00</div>
        </div>
        <div class="header-right">
          <div id="puzzle-progress">ความคืบหน้า</div>
        </div>
      </div>

      <div id="game-board">
        <!-- [SUDOKU] Grid -->
        <div id="sudoku" class="sudoku"></div>
        <!-- [SUDOKU] Number picker -->
        <div class="picker mt-3" id="picker">
          <button class="pick" data-n="1">1</button>
          <button class="pick" data-n="2">2</button>
          <button class="pick" data-n="3">3</button>
          <button class="pick" data-n="4">4</button>
          <button class="pick erase" data-n="0" title="ลบ"><i class="fa-solid fa-eraser"></i></button>
        </div>
      </div>

      <div id="player-finished-view" class="hidden text-center">
        <h2 class="text-2xl font-bold">เยี่ยมมาก!</h2>
        <p class="text-lg">คุณไขปริศนาสำเร็จ</p>
        <div id="practice-score-display" class="my-4">
             <!-- Score will be injected here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div id="game-over-view" class="hidden center-container">
    <div class="results-container">
      <h2 id="results-header"><i class="fas fa-trophy mr-2"></i>สรุปผล Sudoku!</h2>
      <div class="podium" id="podium-container"></div>
      <div class="other-rankings" id="other-rankings-container">
        <h3>อันดับอื่นๆ</h3>
        <ol id="other-rankings-list"></ol>
      </div>
      <button id="back-to-lobby-btn" class="mt-8 px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">กลับไปที่ล็อบบี้</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module" src="script.min.js"></script>
</body>
</html>
